name: Foil CI/CD

on:
  push:
    branches: [main, 'feature/**']
  pull_request:
    branches: [main]

env:
  GLEAM_VERSION: '1.6.2'
  OTP_VERSION: '27.2'

jobs:
  # =============================================================================
  # Test Jobs
  # =============================================================================

  test-modal-logic:
    name: Test modal_logic
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Gleam
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          gleam-version: ${{ env.GLEAM_VERSION }}

      - name: Download dependencies
        run: |
          cd packages/modal_logic
          gleam deps download

      - name: Run tests
        run: |
          cd packages/modal_logic
          gleam test

  test-anthropic:
    name: Test anthropic_gleam
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Gleam
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          gleam-version: ${{ env.GLEAM_VERSION }}

      - name: Download dependencies
        run: |
          cd packages/anthropic_gleam
          gleam deps download

      - name: Run tests
        run: |
          cd packages/anthropic_gleam
          gleam test

  test-z3:
    name: Test z3_gleam
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Gleam
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          gleam-version: ${{ env.GLEAM_VERSION }}

      - name: Install Z3
        run: |
          sudo apt-get update
          sudo apt-get install -y z3

      - name: Download dependencies
        run: |
          cd packages/z3_gleam
          gleam deps download

      - name: Run tests
        run: |
          cd packages/z3_gleam
          gleam test

  # =============================================================================
  # Build Jobs
  # =============================================================================

  build-packages:
    name: Build all packages
    runs-on: ubuntu-latest
    needs: [test-modal-logic, test-anthropic, test-z3]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Gleam
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          gleam-version: ${{ env.GLEAM_VERSION }}

      - name: Build anthropic_gleam
        run: |
          cd packages/anthropic_gleam
          gleam build

      - name: Build z3_gleam
        run: |
          cd packages/z3_gleam
          gleam build

      - name: Build modal_logic
        run: |
          cd packages/modal_logic
          gleam build

  build-analyst:
    name: Build analyst
    runs-on: ubuntu-latest
    needs: [build-packages]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Gleam
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          gleam-version: ${{ env.GLEAM_VERSION }}

      - name: Install Z3
        run: |
          sudo apt-get update
          sudo apt-get install -y z3

      - name: Download dependencies
        run: |
          cd apps/analyst
          gleam deps download

      - name: Build analyst application
        run: |
          cd apps/analyst
          gleam build

      - name: Build escript
        run: |
          cd apps/analyst
          gleam run -m gleescript

  # =============================================================================
  # Code Quality Jobs
  # =============================================================================

  lint-modal-logic:
    name: Check formatting - modal_logic
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Gleam
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          gleam-version: ${{ env.GLEAM_VERSION }}

      - name: Check formatting
        run: |
          cd packages/modal_logic
          gleam format --check src test

  lint-anthropic:
    name: Check formatting - anthropic_gleam
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Gleam
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          gleam-version: ${{ env.GLEAM_VERSION }}

      - name: Check formatting
        run: |
          cd packages/anthropic_gleam
          gleam format --check src test

  lint-z3:
    name: Check formatting - z3_gleam
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Gleam
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          gleam-version: ${{ env.GLEAM_VERSION }}

      - name: Check formatting
        run: |
          cd packages/z3_gleam
          gleam format --check src test

  # =============================================================================
  # Summary Job
  # =============================================================================

  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [test-modal-logic, test-anthropic, test-z3, build-packages, build-analyst, lint-modal-logic, lint-anthropic, lint-z3]
    steps:
      - name: Success
        run: echo "All CI checks passed!"
